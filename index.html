<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Qoo10 ìµœì €ê°€ ë§¤ì¹­ ì‹œìŠ¤í…œ - TheKple</title>
<style>
:root{--primary:#7c3aed;--primary-light:#a78bfa;--accent:#f59e0b;--success:#10b981;--danger:#ef4444;--warning:#f97316;--info:#3b82f6;--bg:#f8f7ff;--card:#fff;--text:#1e1b4b;--text-light:#6b7280;--border:#e5e7eb;--shadow:0 2px 12px rgba(124,58,237,0.08);--shadow-lg:0 8px 32px rgba(124,58,237,0.12);--radius:12px;--radius-sm:8px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Pretendard',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);line-height:1.6}
.header{background:linear-gradient(135deg,#7c3aed 0%,#a78bfa 40%,#c4b5fd 60%,#fbbf24 100%);padding:40px 20px 30px;text-align:center;position:relative;overflow:hidden}
.header::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle,rgba(255,255,255,0.1) 0%,transparent 50%);animation:hs 8s ease-in-out infinite}
@keyframes hs{0%,100%{transform:translateX(-10%) translateY(-10%)}50%{transform:translateX(10%) translateY(10%)}}
.header-icon{font-size:42px;position:relative}.header h1{font-size:28px;font-weight:800;color:#fff;text-shadow:0 2px 8px rgba(0,0,0,.15);position:relative}.header p{color:rgba(255,255,255,.9);font-size:15px;margin-top:6px;position:relative}
.toolbar{background:rgba(255,255,255,.85);backdrop-filter:blur(10px);margin:-15px 40px 0;padding:12px 24px;border-radius:var(--radius);display:flex;align-items:center;justify-content:center;gap:12px;box-shadow:var(--shadow-lg);position:relative;z-index:10;flex-wrap:wrap}
.toolbar .status{font-size:13px;color:var(--text-light)}.toolbar .dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--success);margin-right:4px;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 18px;border:none;border-radius:var(--radius-sm);font-size:13px;font-weight:600;cursor:pointer;transition:all .2s}
.btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.15)}.btn:active{transform:translateY(0)}.btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
.btn-primary{background:var(--primary);color:#fff}.btn-success{background:var(--success);color:#fff}.btn-warning{background:var(--accent);color:#fff}.btn-danger{background:var(--danger);color:#fff}
.btn-outline{background:#fff;color:var(--primary);border:1.5px solid var(--primary)}.btn-sm{padding:5px 12px;font-size:12px}.btn-lg{padding:12px 28px;font-size:15px}
.tabs-container{max-width:1300px;margin:24px auto 0;padding:0 20px}.tabs{display:flex;border-bottom:2px solid var(--border);overflow-x:auto}
.tab{padding:14px 22px;font-size:14px;font-weight:600;color:var(--text-light);cursor:pointer;border-bottom:3px solid transparent;transition:all .2s;white-space:nowrap;display:flex;align-items:center;gap:6px}
.tab:hover{color:var(--primary);background:rgba(124,58,237,.04)}.tab.active{color:var(--primary);border-bottom-color:var(--primary)}
.content{max-width:1300px;margin:0 auto;padding:24px 20px 60px}.tab-panel{display:none}.tab-panel.active{display:block;animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:24px;margin-bottom:20px;border:1px solid rgba(124,58,237,.06)}
.card-title{font-size:18px;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}
.stat-card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:24px;text-align:center;border:1px solid rgba(124,58,237,.06);transition:transform .2s}
.stat-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-lg)}.stat-label{font-size:13px;color:var(--text-light);margin-bottom:8px}.stat-value{font-size:36px;font-weight:800}
.stat-value.purple{color:var(--primary)}.stat-value.green{color:var(--success)}.stat-value.orange{color:var(--accent)}.stat-value.red{color:var(--danger)}.stat-value.blue{color:var(--info)}
.table-wrapper{overflow-x:auto}table{width:100%;border-collapse:collapse;font-size:13px}
th{background:#f9fafb;padding:12px 14px;text-align:left;font-weight:700;color:var(--text-light);border-bottom:2px solid var(--border);white-space:nowrap}
td{padding:12px 14px;border-bottom:1px solid var(--border);vertical-align:middle}tr:hover td{background:rgba(124,58,237,.02)}
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700}
.badge-rank1{background:#fef3c7;color:#92400e}.badge-hold{background:#d1fae5;color:#065f46}.badge-undercut{background:#dbeafe;color:#1e40af}
.badge-alert{background:#fef3c7;color:#92400e}.badge-blocked{background:#fee2e2;color:#991b1b}.badge-our{background:#ede9fe;color:#5b21b6;border:1.5px solid #a78bfa}
.form-group{margin-bottom:16px}.form-label{display:block;font-size:13px;font-weight:600;color:var(--text);margin-bottom:6px}
.form-input,.form-select{width:100%;padding:10px 14px;border:1.5px solid var(--border);border-radius:var(--radius-sm);font-size:14px;color:var(--text);background:#fff;transition:border-color .2s}
.form-input:focus,.form-select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(124,58,237,.1)}
.form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px}.form-help{font-size:11px;color:var(--text-light);margin-top:4px}
.form-inline{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:1000;justify-content:center;align-items:center}
.modal-overlay.show{display:flex}.modal{background:#fff;border-radius:var(--radius);padding:30px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3);animation:mi .3s ease}
@keyframes mi{from{opacity:0;transform:scale(.95) translateY(10px)}}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}.modal-header h3{font-size:18px;font-weight:700}
.modal-close{width:32px;height:32px;border:none;background:#f3f4f6;border-radius:50%;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center}
.log-area{background:#1e1b4b;color:#a5f3fc;border-radius:var(--radius-sm);padding:16px;font-family:'Consolas','Courier New',monospace;font-size:12px;max-height:400px;overflow-y:auto;line-height:1.8}
.log-area .log-time{color:#818cf8}.log-area .log-info{color:#34d399}.log-area .log-warn{color:#fbbf24}.log-area .log-error{color:#f87171}.log-area .log-action{color:#c084fc;font-weight:bold}
.price-bar{display:flex;align-items:center;gap:8px;margin:4px 0}
.price-bar-fill{height:26px;border-radius:4px;display:flex;align-items:center;padding:0 10px;font-size:11px;font-weight:700;color:#fff;min-width:50px;transition:width .5s ease}
.price-bar-name{font-size:12px;min-width:120px;text-align:right;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.price-bar-price{font-size:13px;font-weight:700;min-width:70px}
.toggle-wrapper{display:flex;align-items:center;gap:10px}.toggle{position:relative;width:48px;height:26px;cursor:pointer}.toggle input{display:none}
.toggle-slider{position:absolute;inset:0;background:#d1d5db;border-radius:26px;transition:.3s}
.toggle-slider::before{content:'';position:absolute;width:20px;height:20px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.3s;box-shadow:0 1px 3px rgba(0,0,0,.2)}
.toggle input:checked+.toggle-slider{background:var(--primary)}.toggle input:checked+.toggle-slider::before{transform:translateX(22px)}.toggle-label{font-size:13px;font-weight:600}
.progress-bar{width:100%;height:6px;background:#e5e7eb;border-radius:3px;overflow:hidden;margin:8px 0}.progress-fill{height:100%;background:linear-gradient(90deg,var(--primary),var(--accent));border-radius:3px;transition:width .3s}
.spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
@media(max-width:768px){.toolbar{margin:-15px 15px 0;padding:10px 16px}.stats-row{grid-template-columns:repeat(2,1fr)}.header h1{font-size:22px}.form-row{grid-template-columns:1fr}}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
</head>
<body>

<div class="header">
  <div class="header-icon">ğŸ·ï¸</div>
  <h1>Qoo10 ìµœì €ê°€ ë§¤ì¹­ ì‹œìŠ¤í…œ</h1>
  <p>TheKple ìŠ¤í† ì–´ ìë™ ê°€ê²© ëª¨ë‹ˆí„°ë§ ë° ìµœì €ê°€ ìœ ì§€ ì†”ë£¨ì…˜</p>
</div>

<div class="toolbar">
  <span class="status"><span class="dot" id="statusDot"></span><span id="statusText">ëŒ€ê¸° ì¤‘</span></span>
  <button class="btn btn-outline" onclick="switchTab('settings')">âš™ï¸ ì„¤ì •</button>
  <button class="btn btn-primary" onclick="saveAllData()">ğŸ’¾ ì €ì¥</button>
  <button class="btn btn-success" id="btnRun" onclick="runMonitoring()">ğŸ” ëª¨ë‹ˆí„°ë§ ì‹¤í–‰</button>
  <button class="btn btn-warning" onclick="stopMonitoring()">â¹ ì¤‘ì§€</button>
</div>

<div class="tabs-container">
  <div class="tabs">
    <div class="tab active" data-tab="dashboard" onclick="switchTab('dashboard')">ğŸ“Š ëŒ€ì‹œë³´ë“œ</div>
    <div class="tab" data-tab="catalogs" onclick="switchTab('catalogs')">ğŸ“¦ ì¹´íƒˆë¡œê·¸ ê´€ë¦¬</div>
    <div class="tab" data-tab="monitoring" onclick="switchTab('monitoring')">ğŸ” ê°€ê²© ëª¨ë‹ˆí„°ë§</div>
    <div class="tab" data-tab="history" onclick="switchTab('history')">ğŸ“ˆ ê°€ê²© ì´ë ¥</div>
    <div class="tab" data-tab="settings" onclick="switchTab('settings')">âš™ï¸ ì„¤ì •</div>
  </div>
</div>

<div class="content">
  <!-- ëŒ€ì‹œë³´ë“œ -->
  <div class="tab-panel active" id="panel-dashboard">
    <div class="stats-row">
      <div class="stat-card"><div class="stat-label">ë“±ë¡ ì¹´íƒˆë¡œê·¸</div><div class="stat-value purple" id="stat-catalogs">0</div></div>
      <div class="stat-card"><div class="stat-label">ìµœì €ê°€ 1ìœ„</div><div class="stat-value green" id="stat-rank1">0</div></div>
      <div class="stat-card"><div class="stat-label">ê°€ê²© ì¡°ì • í•„ìš”</div><div class="stat-value orange" id="stat-needs">0</div></div>
      <div class="stat-card"><div class="stat-label">ê²½ê³ </div><div class="stat-value red" id="stat-alerts">0</div></div>
      <div class="stat-card"><div class="stat-label">ì˜¤ëŠ˜ ë³€ê²½</div><div class="stat-value blue" id="stat-changes">0</div></div>
    </div>
    <div id="progressArea" style="display:none" class="card">
      <div class="card-title">ğŸ”„ ëª¨ë‹ˆí„°ë§ ì§„í–‰ ì¤‘...</div>
      <div id="progressText" style="font-size:13px;color:var(--text-light);margin-bottom:4px">ì¤€ë¹„ ì¤‘...</div>
      <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
    </div>
    <div class="card">
      <div class="card-title">ğŸ“‹ ì¹´íƒˆë¡œê·¸ í˜„í™©</div>
      <div class="table-wrapper">
        <table><thead><tr><th>ì¹´íƒˆë¡œê·¸</th><th>ìƒí’ˆëª…</th><th>ìˆœìœ„</th><th>ìš°ë¦¬ ê°€ê²©</th><th>1ìœ„ ê°€ê²©</th><th>ì°¨ì´</th><th>ìƒíƒœ</th><th>í™•ì¸ì‹œê°„</th></tr></thead>
        <tbody id="dashboardBody"><tr><td colspan="8" style="text-align:center;color:var(--text-light);padding:40px">ëª¨ë‹ˆí„°ë§ì„ ì‹¤í–‰í•˜ì„¸ìš”</td></tr></tbody></table>
      </div>
    </div>
    <div class="card"><div class="card-title">ğŸ“Š ì‹¤ì‹œê°„ ë¡œê·¸</div><div class="log-area" id="logArea"><div><span class="log-time">[ì‹œìŠ¤í…œ]</span> ì„œë²„ ì—°ê²° í™•ì¸ ì¤‘...</div></div></div>
  </div>

  <!-- ì¹´íƒˆë¡œê·¸ ê´€ë¦¬ -->
  <div class="tab-panel" id="panel-catalogs">
    <div class="card">
      <div class="card-title" style="justify-content:space-between"><span>ğŸ“¦ ì¹´íƒˆë¡œê·¸ ê´€ë¦¬</span><button class="btn btn-primary btn-sm" onclick="openAddCatalog()">â• ì¶”ê°€</button></div>
      <div class="table-wrapper">
        <table><thead><tr><th>ë²ˆí˜¸</th><th>ìƒí’ˆëª…</th><th>ìƒí’ˆì½”ë“œ</th><th>ë°”ë‹¥ê°€</th><th>ì–¸ë”ì»·</th><th>í™œì„±</th><th>ê´€ë¦¬</th></tr></thead>
        <tbody id="catalogBody"></tbody></table>
      </div>
    </div>
  </div>

  <!-- ê°€ê²© ëª¨ë‹ˆí„°ë§ -->
  <div class="tab-panel" id="panel-monitoring">
    <div class="card">
      <div class="card-title" style="justify-content:space-between">
        <span>ğŸ” ëª¨ë‹ˆí„°ë§ ê²°ê³¼</span>
        <button class="btn btn-success btn-sm" onclick="runMonitoring()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
      </div>
      <div id="monitorResults"><div style="text-align:center;color:var(--text-light);padding:40px">ëª¨ë‹ˆí„°ë§ì„ ì‹¤í–‰í•˜ë©´ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤</div></div>
    </div>
  </div>

  <!-- ê°€ê²© ì´ë ¥ -->
  <div class="tab-panel" id="panel-history">
    <div class="card">
      <div class="card-title"><span>ğŸ“ˆ ê°€ê²© ë³€ë™ ì´ë ¥</span></div>
      <div class="table-wrapper">
        <table><thead><tr><th>ì¼ì‹œ</th><th>ì¹´íƒˆë¡œê·¸</th><th>ìƒí’ˆëª…</th><th>ì´ì „</th><th>ë³€ê²½</th><th>ë³€ë™</th><th>ì‚¬ìœ </th><th>ì ìš©</th></tr></thead>
        <tbody id="historyBody"><tr><td colspan="8" style="text-align:center;color:var(--text-light);padding:40px">ì´ë ¥ ì—†ìŒ</td></tr></tbody></table>
      </div>
    </div>
  </div>

  <!-- ì„¤ì • -->
  <div class="tab-panel" id="panel-settings">
    <div class="card">
      <div class="card-title">ğŸª ìŠ¤í† ì–´ ì •ë³´</div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">ìŠ¤í† ì–´ëª…</label><input class="form-input" id="set-storeName" value="thekple"><div class="form-help">Qoo10 ì…€ëŸ¬ ë¦¬ìŠ¤íŠ¸ì—ì„œ ì‹ë³„í•  ì´ë¦„</div></div>
        <div class="form-group"><label class="form-label">Qoo10 API Key (ì„ íƒ)</label><input class="form-input" id="set-apiKey" type="password" placeholder="ì—†ìœ¼ë©´ ìˆ˜ë™ ë³€ê²½"></div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">ğŸ’° ê°€ê²© ì „ëµ</div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">ê¸°ë³¸ ì–¸ë”ì»· (Â¥)</label><input class="form-input" id="set-undercut" type="number" value="1" min="1"></div>
        <div class="form-group"><label class="form-label">ìµœëŒ€ í•˜ë½ í—ˆìš© (Â¥)</label><input class="form-input" id="set-maxDrop" type="number" value="200"></div>
        <div class="form-group"><label class="form-label">24ì‹œê°„ ìµœëŒ€ ì¸í•˜ íšŸìˆ˜</label><input class="form-input" id="set-maxDrops" type="number" value="3"></div>
      </div>
      <div style="margin-top:12px"><div class="toggle-wrapper"><label class="toggle"><input type="checkbox" id="set-dryRun" checked><span class="toggle-slider"></span></label><span class="toggle-label">Dry-Run ëª¨ë“œ (ì‹¤ì œ ë³€ê²½ ì•ˆ í•¨)</span></div></div>
    </div>
    <div style="text-align:center;margin-top:20px">
      <button class="btn btn-primary btn-lg" onclick="saveSettings()">ğŸ’¾ ì„¤ì • ì €ì¥</button>
      <button class="btn btn-outline btn-lg" style="margin-left:12px" onclick="exportAll()">ğŸ“¤ ë°±ì—…</button>
      <button class="btn btn-outline btn-lg" style="margin-left:12px" onclick="importAll()">ğŸ“¥ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    </div>
  </div>
</div>

<!-- ì¹´íƒˆë¡œê·¸ ì¶”ê°€ ëª¨ë‹¬ -->
<div class="modal-overlay" id="modalAdd">
  <div class="modal">
    <div class="modal-header"><h3>ğŸ“¦ ì¹´íƒˆë¡œê·¸ ì¶”ê°€</h3><button class="modal-close" onclick="closeModal('modalAdd')">âœ•</button></div>
    <div class="form-group"><label class="form-label">ì¹´íƒˆë¡œê·¸ ë²ˆí˜¸ *</label><input class="form-input" id="add-no" type="number" placeholder="32917"><div class="form-help">Qoo10 URLì˜ catalogno= ê°’</div></div>
    <div class="form-group"><label class="form-label">ìƒí’ˆëª… *</label><input class="form-input" id="add-name" placeholder="ãƒãƒ‡ã‚«ãƒãƒªã‚¢ãƒœãƒ‡ã‚£ãƒ­ãƒ¼ã‚·ãƒ§ãƒ³ 500ml"></div>
    <div class="form-group"><label class="form-label">ìƒí’ˆì½”ë“œ</label><input class="form-input" id="add-code" placeholder="KPLE-001"></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">ë°”ë‹¥ê°€ (Â¥) *</label><input class="form-input" id="add-floor" type="number"></div>
      <div class="form-group"><label class="form-label">ì–¸ë”ì»· (Â¥)</label><input class="form-input" id="add-uc" type="number" value="1"></div>
    </div>
    <div style="text-align:right;margin-top:20px">
      <button class="btn btn-outline" onclick="closeModal('modalAdd')">ì·¨ì†Œ</button>
      <button class="btn btn-primary" style="margin-left:8px" onclick="addCatalog()">ì¶”ê°€</button>
    </div>
  </div>
</div>

<script>
const API = 'http://localhost:5000/api';
let state = {
  settings:{storeName:'thekple',apiKey:'',undercut:1,maxDrop:200,maxDrops:3,dryRun:true},
  catalogs:[{catalogNo:32917,productName:'ãƒãƒ‡ã‚«ãƒãƒªã‚¢ãƒœãƒ‡ã‚£ãƒ­ãƒ¼ã‚·ãƒ§ãƒ³ 500ml',itemCode:'KPLE-001',floorPrice:1200,undercut:1,active:true}],
  results:[], history:[], lastRun:null
};
let isMonitoring=false, timer=null;

function load(){try{const s=localStorage.getItem('q10pm3');if(s)state={...state,...JSON.parse(s)};}catch(e){}applyUI();renderAll();checkServer();}
function save(){try{localStorage.setItem('q10pm3',JSON.stringify(state));}catch(e){}}

async function checkServer(){
  try{const r=await fetch(API+'/scrape/0',{signal:AbortSignal.timeout(3000)});addLog('info','âœ… ë°±ì—”ë“œ ì„œë²„ ì—°ê²° í™•ì¸');}
  catch(e){addLog('error','âŒ ë°±ì—”ë“œ ì„œë²„ ë¯¸ì—°ê²°! python server.pyë¥¼ ë¨¼ì € ì‹¤í–‰í•˜ì„¸ìš”');addLog('warn','  â†’ pip install flask flask-cors playwright');addLog('warn','  â†’ playwright install chromium');addLog('warn','  â†’ python server.py');}
}

// === TABS ===
function switchTab(id){document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));document.querySelector(`.tab[data-tab="${id}"]`)?.classList.add('active');document.getElementById(`panel-${id}`)?.classList.add('active');}
function openModal(id){document.getElementById(id).classList.add('show');}function closeModal(id){document.getElementById(id).classList.remove('show');}

// === CATALOG ===
function openAddCatalog(){['add-no','add-name','add-code','add-floor'].forEach(id=>document.getElementById(id).value='');document.getElementById('add-uc').value='1';openModal('modalAdd');}
function addCatalog(){
  const no=parseInt(document.getElementById('add-no').value),name=document.getElementById('add-name').value.trim(),floor=parseInt(document.getElementById('add-floor').value);
  if(!no||!name||!floor){alert('ë²ˆí˜¸,ìƒí’ˆëª…,ë°”ë‹¥ê°€ í•„ìˆ˜');return;}if(state.catalogs.some(c=>c.catalogNo===no)){alert('ì´ë¯¸ ë“±ë¡ë¨');return;}
  state.catalogs.push({catalogNo:no,productName:name,itemCode:document.getElementById('add-code').value.trim()||`KPLE-${no}`,floorPrice:floor,undercut:parseInt(document.getElementById('add-uc').value)||1,active:true});
  save();renderCatalogs();closeModal('modalAdd');addLog('info',`ì¹´íƒˆë¡œê·¸ ì¶”ê°€: #${no}`);
}
function removeCatalog(no){if(!confirm(`#${no} ì‚­ì œ?`))return;state.catalogs=state.catalogs.filter(c=>c.catalogNo!==no);save();renderCatalogs();}
function toggleCatalog(no){const c=state.catalogs.find(x=>x.catalogNo===no);if(c){c.active=!c.active;save();renderCatalogs();}}
function renderCatalogs(){
  const tb=document.getElementById('catalogBody');document.getElementById('stat-catalogs').textContent=state.catalogs.length;
  if(!state.catalogs.length){tb.innerHTML='<tr><td colspan="7" style="text-align:center;color:var(--text-light);padding:30px">ì¹´íƒˆë¡œê·¸ ì—†ìŒ</td></tr>';return;}
  tb.innerHTML=state.catalogs.map(c=>`<tr style="opacity:${c.active?1:.5}"><td><strong>${c.catalogNo}</strong></td><td>${c.productName}</td>
  <td><code style="background:#f3f4f6;padding:2px 6px;border-radius:4px;font-size:12px">${c.itemCode}</code></td><td>Â¥${c.floorPrice.toLocaleString()}</td><td>Â¥${c.undercut}</td>
  <td><label class="toggle" style="width:40px;height:22px"><input type="checkbox" ${c.active?'checked':''} onchange="toggleCatalog(${c.catalogNo})"><span class="toggle-slider"></span></label></td>
  <td><button class="btn btn-outline btn-sm" onclick="window.open('https://www.qoo10.jp/gmkt.inc/catalog/goods/goods.aspx?catalogno=${c.catalogNo}','_blank')">ğŸ”—</button> <button class="btn btn-danger btn-sm" onclick="removeCatalog(${c.catalogNo})">ğŸ—‘ï¸</button></td></tr>`).join('');
}

// === MONITORING (ì‹¤ì œ ì„œë²„ í˜¸ì¶œ) ===
async function runMonitoring(){
  const active=state.catalogs.filter(c=>c.active);
  if(!active.length){addLog('error','í™œì„± ì¹´íƒˆë¡œê·¸ ì—†ìŒ');return;}
  if(isMonitoring){addLog('warn','ì´ë¯¸ ì‹¤í–‰ ì¤‘');return;}
  isMonitoring=true;document.getElementById('btnRun').disabled=true;
  setStatus('monitoring','ëª¨ë‹ˆí„°ë§ ì¤‘...');
  document.getElementById('progressArea').style.display='block';
  addLog('action',`=== ëª¨ë‹ˆí„°ë§ ì‹œì‘: ${active.length}ê°œ ===`);
  state.results=[];

  for(let i=0;i<active.length;i++){
    const cat=active[i];
    document.getElementById('progressFill').style.width=Math.round(i/active.length*100)+'%';
    document.getElementById('progressText').textContent=`(${i+1}/${active.length}) #${cat.catalogNo} ${cat.productName} ìŠ¤í¬ë˜í•‘ ì¤‘... (Playwright)`;
    addLog('info',`ğŸ” #${cat.catalogNo} ${cat.productName} ì‹¤ì œ ìŠ¤í¬ë˜í•‘...`);

    try{
      const resp=await fetch(`${API}/scrape/${cat.catalogNo}`);
      const data=await resp.json();

      if(data.success && data.sellers && data.sellers.length>0){
        addLog('info',`  âœ… ${data.sellers.length}ê°œ ì…€ëŸ¬ ë°œê²¬`);
        data.sellers.forEach(s=>{ s.isOurs = s.name.toLowerCase().includes(state.settings.storeName.toLowerCase()); });
        const result=analyze(cat, data.sellers);
        state.results.push(result);
        const em={HOLD:'âœ…',UNDERCUT:'ğŸ’°',ALERT:'âš ï¸',BLOCKED:'ğŸ›‘'}[result.action]||'ğŸ“‹';
        addLog(result.action==='HOLD'?'info':result.action==='UNDERCUT'?'action':'warn',`  ${em} [${result.action}] ${result.reason}`);
        if(result.action==='UNDERCUT'&&result.recPrice) state.history.unshift({ts:new Date().toISOString(),catNo:cat.catalogNo,name:cat.productName,old:result.curPrice,new:result.recPrice,reason:result.reason,applied:!state.settings.dryRun});
      } else {
        addLog('warn',`  âš ï¸ ì…€ëŸ¬ ë°ì´í„° ì—†ìŒ (í˜ì´ì§€ êµ¬ì¡°ê°€ JSë¡œ ë¡œë”© ì¤‘ì¼ ìˆ˜ ìˆìŒ)`);
        if(data.error) addLog('error',`  ì—ëŸ¬: ${data.error}`);
        state.results.push({catNo:cat.catalogNo,name:cat.productName,rank:null,curPrice:null,topSeller:'N/A',topPrice:0,recPrice:null,action:'ALERT',reason:'ì…€ëŸ¬ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨ - ë””ë²„ê·¸ ìŠ¤í¬ë¦°ìƒ· í™•ì¸: /api/debug/'+cat.catalogNo,sellers:[]});
      }
    }catch(e){
      addLog('error',`  âŒ ì„œë²„ ì—ëŸ¬: ${e.message}`);
      state.results.push({catNo:cat.catalogNo,name:cat.productName,rank:null,curPrice:null,topSeller:'N/A',topPrice:0,recPrice:null,action:'ALERT',reason:`ì„œë²„ ì—°ê²° ì‹¤íŒ¨: ${e.message}`,sellers:[]});
    }
  }

  document.getElementById('progressFill').style.width='100%';
  document.getElementById('progressText').textContent='ì™„ë£Œ!';
  setTimeout(()=>document.getElementById('progressArea').style.display='none',2000);

  state.lastRun=new Date().toISOString();isMonitoring=false;document.getElementById('btnRun').disabled=false;
  const r1=state.results.filter(r=>r.action==='HOLD'&&r.rank===1).length;
  const needs=state.results.filter(r=>r.action==='UNDERCUT').length;
  const alerts=state.results.filter(r=>['ALERT','BLOCKED'].includes(r.action)).length;
  document.getElementById('stat-rank1').textContent=r1;document.getElementById('stat-needs').textContent=needs;document.getElementById('stat-alerts').textContent=alerts;
  document.getElementById('stat-changes').textContent=state.history.filter(h=>h.ts?.startsWith(new Date().toISOString().slice(0,10))).length;
  setStatus('done',`ì™„ë£Œ (${new Date().toLocaleTimeString()})`);
  addLog('action',`=== ì™„ë£Œ: 1ìœ„:${r1} ì¡°ì •:${needs} ê²½ê³ :${alerts} ===`);
  save();renderAll();
}

function analyze(cat,sellers){
  sellers.sort((a,b)=>a.price-b.price);sellers.forEach((s,i)=>s.rank=i+1);
  const our=sellers.find(s=>s.isOurs), comps=sellers.filter(s=>!s.isOurs), top=comps[0];
  if(!top)return{catNo:cat.catalogNo,name:cat.productName,rank:our?.rank,curPrice:our?.price,topSeller:'ì—†ìŒ',topPrice:0,recPrice:our?.price,action:'HOLD',reason:'ê²½ìŸ ì—†ìŒ',sellers};
  if(!our)return{catNo:cat.catalogNo,name:cat.productName,rank:null,curPrice:null,topSeller:top.name,topPrice:top.price,recPrice:Math.max(top.price-cat.undercut,cat.floorPrice),action:'ALERT',reason:`"${state.settings.storeName}" ë¯¸ë°œê²¬. 1ìœ„:${top.name}(Â¥${top.price})`,sellers};
  if(our.rank===1)return{catNo:cat.catalogNo,name:cat.productName,rank:1,curPrice:our.price,topSeller:top.name,topPrice:top.price,recPrice:our.price,action:'HOLD',reason:`ì´ë¯¸ 1ìœ„! ìš°ë¦¬:Â¥${our.price} vs 2ìœ„:Â¥${top.price} (ì°¨ì´:Â¥${top.price-our.price})`,sellers};
  const target=top.price-cat.undercut;
  if(target<cat.floorPrice)return{catNo:cat.catalogNo,name:cat.productName,rank:our.rank,curPrice:our.price,topSeller:top.name,topPrice:top.price,recPrice:cat.floorPrice,action:'ALERT',reason:`ë°”ë‹¥ê°€ ë„ë‹¬! ëª©í‘œÂ¥${target}<ë°”ë‹¥Â¥${cat.floorPrice}. 1ìœ„:${top.name}=Â¥${top.price}`,sellers};
  if(our.price-target>state.settings.maxDrop)return{catNo:cat.catalogNo,name:cat.productName,rank:our.rank,curPrice:our.price,topSeller:top.name,topPrice:top.price,recPrice:Math.max(our.price-state.settings.maxDrop,cat.floorPrice),action:'ALERT',reason:`ê¸‰ë½! Â¥${our.price}â†’Â¥${target}(${our.price-target}ì—”) ìµœëŒ€Â¥${state.settings.maxDrop}í—ˆìš©`,sellers};
  return{catNo:cat.catalogNo,name:cat.productName,rank:our.rank,curPrice:our.price,topSeller:top.name,topPrice:top.price,recPrice:target,action:'UNDERCUT',reason:`1ìœ„ ${top.name}(Â¥${top.price}) ëŒ€ë¹„ Â¥${cat.undercut} ì–¸ë”ì»· â†’ Â¥${target} (í˜„ì¬:Â¥${our.price})`,sellers};
}

function stopMonitoring(){if(timer){clearTimeout(timer);timer=null;}isMonitoring=false;document.getElementById('btnRun').disabled=false;setStatus('idle','ì¤‘ì§€');addLog('warn','ì¤‘ì§€');}

// === RENDER ===
function renderAll(){renderCatalogs();renderDashboard();renderMonitor();renderHistory();}
function renderDashboard(){
  document.getElementById('stat-catalogs').textContent=state.catalogs.length;
  const tb=document.getElementById('dashboardBody');
  if(!state.results.length){tb.innerHTML='<tr><td colspan="8" style="text-align:center;color:var(--text-light);padding:40px">ëª¨ë‹ˆí„°ë§ì„ ì‹¤í–‰í•˜ì„¸ìš”</td></tr>';return;}
  tb.innerHTML=state.results.map(r=>{
    const d=r.curPrice&&r.topPrice?r.curPrice-r.topPrice:0;
    const ds=d>0?`+Â¥${d}`:d<0?`-Â¥${Math.abs(d)}`:'â€”';
    const dc=d>0?'var(--danger)':d<0?'var(--success)':'var(--text-light)';
    const bc={HOLD:'badge-hold',UNDERCUT:'badge-undercut',ALERT:'badge-alert',BLOCKED:'badge-blocked'}[r.action]||'';
    const al={HOLD:'âœ…ìœ ì§€',UNDERCUT:'ğŸ’°ì¡°ì •',ALERT:'âš ï¸ê²½ê³ ',BLOCKED:'ğŸ›‘ì°¨ë‹¨'}[r.action]||r.action;
    return`<tr><td><strong>${r.catNo}</strong></td><td>${r.name}</td><td>${r.rank?`${r.rank}ìœ„`:'-'}</td><td>Â¥${r.curPrice?.toLocaleString()||'-'}</td><td>Â¥${r.topPrice?.toLocaleString()||'-'}</td><td style="color:${dc};font-weight:700">${ds}</td><td><span class="badge ${bc}">${al}</span></td><td style="font-size:12px;color:var(--text-light)">${state.lastRun?new Date(state.lastRun).toLocaleTimeString():'-'}</td></tr>`;
  }).join('');
}
function renderMonitor(){
  const c=document.getElementById('monitorResults');
  if(!state.results.length){c.innerHTML='<div style="text-align:center;color:var(--text-light);padding:40px">ì‹¤í–‰ ëŒ€ê¸°</div>';return;}
  c.innerHTML=state.results.map(r=>{
    if(!r.sellers?.length)return`<div class="card"><strong>#${r.catNo} ${r.name}</strong> â€” ${r.reason}</div>`;
    const mx=Math.max(...r.sellers.map(s=>s.price));
    const bars=r.sellers.map(s=>{
      const w=Math.max(20,(s.price/mx)*100);const o=s.isOurs;
      const cl=o?'var(--primary)':s.rank===1?'var(--success)':'#94a3b8';
      return`<div class="price-bar"><span class="price-bar-name">${o?'â­ ':''}${s.name}</span><div class="price-bar-fill" style="width:${w}%;background:${cl}">${s.rank}ìœ„</div><span class="price-bar-price" style="${o?'color:var(--primary)':''}">Â¥${s.price.toLocaleString()}</span>${o?'<span class="badge badge-our">OUR</span>':''}</div>`;
    }).join('');
    const bc={HOLD:'badge-hold',UNDERCUT:'badge-undercut',ALERT:'badge-alert',BLOCKED:'badge-blocked'}[r.action];
    const al={HOLD:'âœ…ìœ ì§€',UNDERCUT:'ğŸ’°ì¡°ì •',ALERT:'âš ï¸ê²½ê³ ',BLOCKED:'ğŸ›‘ì°¨ë‹¨'}[r.action];
    return`<div class="card" style="margin-bottom:16px"><div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;margin-bottom:12px"><div><strong>#${r.catNo} ${r.name}</strong> <span class="badge ${bc}" style="margin-left:8px">${al}</span></div>${r.recPrice&&r.action==='UNDERCUT'?`<button class="btn btn-warning btn-sm" onclick="alert('${state.settings.dryRun?'[Dry-Run] ':''}Â¥${r.recPrice}ìœ¼ë¡œ ë³€ê²½${state.settings.dryRun?' (ì‹œë®¬ë ˆì´ì…˜)':''}')">${state.settings.dryRun?'ğŸ”':'âœ…'} â†’ Â¥${r.recPrice.toLocaleString()}</button>`:''}</div>
    <div style="font-size:13px;color:var(--text-light);margin-bottom:12px">ğŸ“ ${r.reason}</div>
    <div style="background:#f9fafb;border-radius:8px;padding:12px"><div style="font-size:12px;font-weight:700;color:var(--text-light);margin-bottom:8px">ì…€ëŸ¬ë³„ ê°€ê²© (${r.sellers.length}ê°œ)</div>${bars}</div></div>`;
  }).join('');
}
function renderHistory(){
  const tb=document.getElementById('historyBody');
  if(!state.history.length){tb.innerHTML='<tr><td colspan="8" style="text-align:center;color:var(--text-light);padding:40px">ì´ë ¥ ì—†ìŒ</td></tr>';return;}
  tb.innerHTML=state.history.slice(0,50).map(h=>{const d=(h.old||0)-(h.new||0);const ds=d>0?`â†“Â¥${d}`:d<0?`â†‘Â¥${Math.abs(d)}`:'-';const dc=d>0?'var(--success)':d<0?'var(--danger)':'var(--text-light)';const dt=new Date(h.ts);
  return`<tr><td style="font-size:12px">${dt.toLocaleDateString()} ${dt.toLocaleTimeString()}</td><td><strong>${h.catNo}</strong></td><td>${h.name}</td><td>Â¥${h.old?.toLocaleString()||'-'}</td><td><strong>Â¥${h.new?.toLocaleString()||'-'}</strong></td><td style="color:${dc};font-weight:700">${ds}</td><td style="font-size:11px;max-width:200px;overflow:hidden;text-overflow:ellipsis">${h.reason||''}</td><td><span class="badge ${h.applied?'badge-hold':'badge-alert'}">${h.applied?'ì ìš©':'Dry-run'}</span></td></tr>`;}).join('');
}

// === SETTINGS ===
function applyUI(){const s=state.settings;document.getElementById('set-storeName').value=s.storeName||'';document.getElementById('set-apiKey').value=s.apiKey||'';document.getElementById('set-undercut').value=s.undercut||1;document.getElementById('set-maxDrop').value=s.maxDrop||200;document.getElementById('set-maxDrops').value=s.maxDrops||3;document.getElementById('set-dryRun').checked=s.dryRun!==false;}
function saveSettings(){state.settings={storeName:document.getElementById('set-storeName').value.trim(),apiKey:document.getElementById('set-apiKey').value.trim(),undercut:parseInt(document.getElementById('set-undercut').value)||1,maxDrop:parseInt(document.getElementById('set-maxDrop').value)||200,maxDrops:parseInt(document.getElementById('set-maxDrops').value)||3,dryRun:document.getElementById('set-dryRun').checked};save();addLog('info','ì„¤ì • ì €ì¥');}
function saveAllData(){saveSettings();save();addLog('info','ì „ì²´ ì €ì¥');}
function exportAll(){const b=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=`q10_backup_${new Date().toISOString().slice(0,10)}.json`;a.click();}
function importAll(){const i=document.createElement('input');i.type='file';i.accept='.json';i.onchange=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{try{state={...state,...JSON.parse(ev.target.result)};save();applyUI();renderAll();}catch(e){alert('ì˜¤ë¥˜');}};r.readAsText(f);};i.click();}

// === UTILS ===
function addLog(t,m){const a=document.getElementById('logArea');const tm=new Date().toLocaleTimeString();const c={info:'log-info',warn:'log-warn',error:'log-error',action:'log-action'}[t]||'log-info';a.innerHTML+=`<div><span class="log-time">[${tm}]</span> <span class="${c}">${m}</span></div>`;a.scrollTop=a.scrollHeight;}
function setStatus(s,t){document.getElementById('statusText').textContent=t;document.getElementById('statusDot').style.background={idle:'#9ca3af',monitoring:'#f59e0b',done:'#10b981',error:'#ef4444'}[s]||'#9ca3af';}

load();
</script>
</body>
</html>
